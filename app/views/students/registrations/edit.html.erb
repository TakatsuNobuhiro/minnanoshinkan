<div class="container">
  <h2>学生プロフィール編集</h2>

  <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <%= bootstrap_devise_error_messages! %>

  <div class="form-group">
    <%= f.label :name, 'ニックネーム(必須)' %>
    <%= f.text_field :name, class: 'form-control', required: true %>
  </div>
  <div class="form-group">
    <%= f.label :gender, '男' %>
    <%= f.radio_button :gender, :男 %>
    <%= f.label :gender, '女'%>
    <%= f.radio_button :gender, :女 %>
    <%= f.label :gender, '未選択' %>
    <%= f.radio_button :gender, :未選択 %>
  </div>
  <div class="form-group">
    <%= f.label :prefecture,'出身(都道府県)' %>
    <%= f.select :prefecture, Student.prefectures.keys,{},class: 'form-control' %>
  </div>

  <%= f.file_field :avatar, accept: "image/jpg,image/jpeg,image/gif,image/png" %>

  <div class="listing-form-box">
    <div class="listing-product-detail__category">
      <%= f.label :category, '大学(必須)', class: 'listing-default__label' %>
      <span class="listing-default--require">必須</span>
      <div class="listing-select-wrapper">
        <div class="listing-select-wrapper__box">
          <%= f.select :category, @category_parent_array, {}, {class: 'listing-select-wrapper__box--select', id: 'parent_category'} %>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group">
    <%= f.label :highschool, '出身高校' %>
    <%= f.text_field :highschool, class: 'form-control' %>
  </div>
  <div class="form-group">
    <%= f.label :hobby, '趣味' %>
    <%= f.text_field :hobby, class: 'form-control' %>
  </div>
  <div class="form-group">
    <%= f.label :detail, '自己紹介' %>
    <%= f.text_area :detail, class: 'form-control' %>
  </div>
  <div class="form-group">
    <%= f.submit t('.update'), class: 'btn btn-primary btn-block' %>
  </div>
  <% end %>

  <hr class="devise-link my-5">
  <div class="form-group">
    <%= link_to "トップページ", root_path, class: 'btn btn-info btn-block mb-4' %>
    <%= link_to t('.cancel_my_account'), registration_path(resource_name), data: {confirm: t('.are_you_sure')}, method: :delete, class: 'btn btn-danger btn-block' %>
  </div>
</div>

<script type="text/javascript">
  $(function(){
  // カテゴリーセレクトボックスのオプションを作成
  function appendOption(category){
    var html = `<option value="${category.name}" data-category="${category.id}">${category.name}</option>`;
    return html;
  }
  // 子カテゴリーの表示作成
  function appendChidrenBox(insertHTML){
    var childSelectHtml = '';
    childSelectHtml = `<div class='listing-select-wrapper__added' id= 'children_wrapper'>
                        <div class='listing-select-wrapper__box'>
                          <select class="listing-select-wrapper__box--select" id="child_category" name="category_id">
                            <option value="---" data-category="---">---</option>
                            ${insertHTML}
                          <select>
                          <i class='fas fa-chevron-down listing-select-wrapper__box--arrow-down'></i>
                        </div>
                      </div>`;
    $('.listing-product-detail__category').append(childSelectHtml);
  }

  // 親カテゴリー選択後のイベント
  $('#parent_category').on('change', function(){
    var parentCategory = document.getElementById('parent_category').value; //選択された親カテゴリーの名前を取得
    if (parentCategory != "---"){ //親カテゴリーが初期値でないことを確認
      $.ajax({
        url: 'get_category_children',
        type: 'GET',
        data: { parent_name: parentCategory },
        dataType: 'json'
      })
      .done(function(children){
        $('#children_wrapper').remove(); //親が変更された時、子以下を削除するする
        $('#grandchildren_wrapper').remove();
        $('#size_wrapper').remove();
        $('#brand_wrapper').remove();
        var insertHTML = '';
        children.forEach(function(child){
          insertHTML += appendOption(child);
        });
        appendChidrenBox(insertHTML);
      })
      .fail(function(){
        alert('カテゴリー取得に失敗しました');
      })
    }else{
      $('#children_wrapper').remove(); //親カテゴリーが初期値になった時、子以下を削除するする
      $('#grandchildren_wrapper').remove();
      $('#size_wrapper').remove();
      $('#brand_wrapper').remove();
    }
  });
</script>